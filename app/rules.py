RULES = {
    "EX06": {
        "default": {
            "extractor": {
                (-100, 100): [],
            },
            "condensor": {
                (0, 100): [],
            },
            "drift": {
                (-50, 50): [],
            },
        },
    },
    "ESQ_MAGCIS": {
        "default": {
            "extractor": {
                (-100, 100): [],
            },
            "condensor": {
                (0, 100): [],
            },
            "drift": {
                (-50, 50): ['[10]', '[11]', '[12]', '[13]', '[14]'],
                (900, 1000): ['[15]'],
                (1950, 2050): ['[16]', '[17]', '[18]', '[19]', '[20]'],
                (2900, 3000): ['[21]'],
                (3900, 4000): ['[22]', '[23]', '[24]', '[25]', '[26]'],
                (4850, 4950): ['[27]'],
                (5900, 6000): ['[28]', '[29]', '[30]', '[31]', '[32]'],
                (6850, 6950): ['[33]'],
            },
            "magnet": {
                (-1.8, -1.6): ['[00]', '[01]', '[02]', '[03]', '[04]', '[05]', '[06]', '[07]', '[08]', '[09]'], #monoatomic modes
                (-1.02, -0.98): ['[10]', '[16]', '[22]', '[28]'],
                (-0.42, -0.38): ['[11]', '[17]', '[23]', '[29]'],
                ( 0.38,  0.42): ['[12]', '[18]', '[24]', '[30]'],
                ( 1.08,  1.12): ['[13]', '[19]', '[25]', '[31]'],
                ( 1.78,  1.82): ['[14]', '[15]', '[20]', '[21]', '[26]', '[27]', '[32]', '[33]'],
            },
        },
    },
    "NEXSA_MAGCIS": {
        "default": {
            "extractor": {
                (-100, 100): ['[01]'],
            },
            "condensor": {
                (0, 100): ['[02]'],
            },
            "drift": {
                (-50, 50): ['[12]', '[13]', '[14]', '[15]', '[16]'],
                (900, 1000): ['[17]'],
                (1950, 2050): ['[18]', '[19]', '[20]', '[21]', '[22]'],
                (2900, 3000): ['[23]'],
                (3900, 4000): ['[24]', '[25]', '[26]', '[27]', '[28]'],
                (4850, 4950): ['[29]'],
                (5900, 6000): ['[30]', '[31]', '[32]', '[33]', '[34]'],
                (6850, 6950): ['[35]'],
            },
            "magnet": {
                (-1.8, -1.6): ['[00]', '[01]', '[02]', '[03]', '[04]', '[05]', '[06]', '[07]', '[08]', '[09]', '[10]', '[11]'], #monoatomic modes
                (-1.02, -0.98): ['[12]', '[18]', '[24]', '[30]'],
                (-0.42, -0.38): ['[13]', '[19]', '[25]', '[31]'],
                ( 0.38,  0.42): ['[14]', '[20]', '[26]', '[32]'],
                ( 1.08,  1.12): ['[15]', '[21]', '[27]', '[33]'],
                ( 1.78,  1.82): ['[16]', '[17]', '[22]', '[23]', '[28]', '[29]', '[34]', '[35]'],
            },
        },
    },
    "NEXSA_MAGCIS_ISS": {
        "default": {
            "extractor": {
                (-100, 100): [],
            },
            "condensor": {
                (0, 100): [],
            },
            "drift": {
                (-50, 50): ['[14]', '[15]', '[16]', '[17]', '[18]'],
                (900, 1000): ['[19]'],
                (1950, 2050): ['[20]', '[21]', '[22]', '[23]', '[24]'],
                (2900, 3000): ['[25]'],
                (3900, 4000): ['[26]', '[27]', '[28]', '[29]', '[30]'],
                (4850, 4950): ['[31]'],
                (5900, 6000): ['[32]', '[33]', '[34]', '[35]', '[36]'],
                (6850, 6950): ['[37]'],
            },
            "magnet": {
                (-1.8, -1.6): ['[00]', '[01]', '[02]', '[03]', '[04]', '[05]', '[06]', '[07]', '[08]', '[09]', '[10]', '[11]'], #monoatomic modes
                (-1.02, -0.98): ['[14]', '[20]', '[26]', '[32]'],
                (-0.42, -0.38): ['[15]', '[21]', '[27]', '[33]'],
                ( 0.38,  0.42): ['[16]', '[22]', '[28]', '[34]'],
                ( 1.08,  1.12): ['[17]', '[23]', '[29]', '[35]'],
                ( 1.78,  1.82): ['[18]', '[19]', '[24]', '[25]', '[30]', '[31]', '[36]', '[37]'],
            },
        },
    },
    "NEXSA_EX06_ISS": {
        "default": {
            "extractor": {
                (-100, 100): [],
            },
            "condensor": {
                (0, 100): [],
            },
            "drift": {
                (-50, 50): [],
            },
        },
    },
}

RATIO_RANGE_NEXSA = (0.3, 1.0)
RATIO_RANGE_ESCALAB = (0.4, 1.0)
SHIFT_RANGE = (-100, 100)

def expand_groups(groups):
    return {
        idx: rng
        for rng, indexes in groups.items()
        for idx in indexes
    }

def get_rules_for(system_name, preset="default"):
    try:
        preset_data = RULES[system_name][preset]
    except KeyError as e:
        raise KeyError(f"Invalid system/preset: {system_name}/{preset}") from e

    return {
        param: expand_groups(preset_data.get(param, {}))
        for param in ("extractor", "condensor", "drift", "magnet")
    }
