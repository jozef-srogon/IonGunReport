RULES = {
    "NEXSA_EX06": {
        "default": {
            "drift": {
                (950, 1950): ['[00]'],
            },
        },
    },
    "ESQ_EX06": {
        "default": {
            "drift": {
                (950, 1950): ['[00]'],
            },
        },
    },
    "ESQ_MAGCIS": {
        "default": {
            "drift": {
                (-4000, -3000): ['[00]', '[01]'],
                (-4500, -3500): ['[02]', '[03]'],
                (-3500, -2500): ['[04]', '[05]'],
                (-2500, -1500): ['[06]', '[07]'],
                (-1500, -500): ['[08]', '[09]'],
                (-20, 0): ['[10]', '[11]', '[12]', '[13]', '[14]'],
                (968, 1000): ['[15]'],
                (1955, 2000): ['[16]', '[17]', '[18]', '[19]', '[20]'],
                (2940, 3000): ['[21]'],
                (3930, 4000): ['[22]', '[23]', '[24]', '[25]', '[26]'],
                (4920, 5000): ['[27]'],
                (5910, 6000): ['[28]', '[29]', '[30]', '[31]', '[32]'],
                (6895, 7000): ['[33]'],
            },
            "magnet": {
                (-1.8, -1.59): ['[00]', '[01]', '[02]', '[03]', '[04]', '[05]', '[06]', '[07]', '[08]', '[09]'], #monoatomic modes
                (-1, -0.995): ['[10]', '[16]', '[22]', '[28]'],
                (-0.4, -0.396): ['[11]', '[17]', '[23]', '[29]'],
                ( 0.396,  0.4): ['[12]', '[18]', '[24]', '[30]'],
                ( 1.08,  1.1): ['[13]', '[19]', '[25]', '[31]'],
                ( 1.78,  1.8): ['[14]', '[15]', '[20]', '[21]', '[26]', '[27]', '[32]', '[33]'],
            },
        },
    },
    "NEXSA_MAGCIS": {
        "default": {
            "drift": {
                (-4000, -2500): ['[00]', '[01]'],
                (-4000, -3000): ['[02]', '[03]'],
                (-4500, -3500): ['[04]', '[05]'],
                (-3500, -2500): ['[06]', '[07]'],
                (-2500, -1500): ['[08]', '[09]'],
                (-1500, -500): ['[10]', '[11]'],
                (-20, 0): ['[12]', '[13]', '[14]', '[15]', '[16]'],
                (968, 1000): ['[17]'],
                (1955, 2000): ['[18]', '[19]', '[20]', '[21]', '[22]'],
                (2940, 3000): ['[23]'],
                (3930, 4000): ['[24]', '[25]', '[26]', '[27]', '[28]'],
                (4920, 5000): ['[29]'],
                (5910, 6000): ['[30]', '[31]', '[32]', '[33]', '[34]'],
                (6895, 7000): ['[35]'],
            },
            "magnet": {
                (-1.8, -1.59): ['[00]', '[01]', '[02]', '[03]', '[04]', '[05]', '[06]', '[07]', '[08]', '[09]', '[10]', '[11]'], #monoatomic modes
                (-1, -0.995): ['[12]', '[18]', '[24]', '[30]'],
                (-0.4, -0.396): ['[13]', '[19]', '[25]', '[31]'],
                ( 0.396,  0.4): ['[14]', '[20]', '[26]', '[32]'],
                ( 1.08,  1.1): ['[15]', '[21]', '[27]', '[33]'],
                ( 1.78,  1.8): ['[16]', '[17]', '[22]', '[23]', '[28]', '[29]', '[34]', '[35]'],
            },
        },
    },
    "NEXSA_MAGCIS_ISS": {
        "default": {
            "drift": {
                (-4000, -2500): ['[00]', '[01]'],
                (-4000, -3000): ['[02]', '[03]'],
                (-4500, -3500): ['[04]', '[05]'],
                (-3500, -2500): ['[06]', '[07]'],
                (-2500, -1500): ['[08]', '[09]'],
                (-1500, -500): ['[10]', '[11]'],
                (-20, 0): ['[14]', '[15]', '[16]', '[17]', '[18]'],
                (968, 1000): ['[19]'],
                (1955, 2000): ['[20]', '[21]', '[22]', '[23]', '[24]'],
                (2940, 3000): ['[25]'],
                (3930, 4000): ['[26]', '[27]', '[28]', '[29]', '[30]'],
                (4920, 5000): ['[31]'],
                (5910, 6000): ['[32]', '[33]', '[34]', '[35]', '[36]'],
                (6895, 7000): ['[37]'],
            },
            "magnet": {
                (-1.8, -1.59): ['[00]', '[01]', '[02]', '[03]', '[04]', '[05]', '[06]', '[07]', '[08]', '[09]', '[10]', '[11]'], #monoatomic modes
                #MODY NA ISS 12,13 chybi, nechceme mit blokovane magnety
                (-1, -0.995): ['[14]', '[20]', '[26]', '[32]'],
                (-0.4, -0.396): ['[15]', '[21]', '[27]', '[33]'],
                ( 0.396,  0.4): ['[16]', '[22]', '[28]', '[34]'],
                ( 1.08,  1.1): ['[17]', '[23]', '[29]', '[35]'],
                ( 1.78,  1.8): ['[18]', '[19]', '[24]', '[25]', '[30]', '[31]', '[36]', '[37]'],
            },
        },
    },
    "NEXSA_EX06_ISS": {
        "default": {
            "drift": {
                (950, 1950): ['[00]'],
            },
        },
    },
}

RATIO_RANGE_NEXSA = (0.3, 1.0)
RATIO_RANGE_ESCALAB = (0.4, 1.0)
RATIO_RANGE_SPEC = (0.5, 1.0)
SHIFT_RANGE = (-100, 100)

def expand_groups(groups):
    return {
        idx: rng
        for rng, indexes in groups.items()
        for idx in indexes
    }

def get_rules_for(system_name, preset="default"):
    try:
        preset_data = RULES[system_name][preset]
    except KeyError as e:
        raise KeyError(f"Invalid system/preset: {system_name}/{preset}") from e

    return {
        param: expand_groups(preset_data.get(param, {}))
        for param in ("extractor", "drift", "magnet")
    }
